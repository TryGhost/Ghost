<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="UTF-8" />

    <title>Ghost</title>

    {{content-for "head"}}

    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimal-ui, viewport-fit=cover" />
    <meta name="pinterest" content="nopin" />

    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Ghost" />
    <meta name="apple-mobile-web-app-title" content="Ghost" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <link rel="shortcut icon" href="assets/img/favicon.ico" />
    <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png" />

    <!-- variables that we don't want postcss-custom-properties to remove -->
    <style>
        :root {
            --editor-sidebar-width: 0px;
        }
    </style>

    <link integrity="" rel="stylesheet" href="{{rootURL}}assets/vendor.css">
    <link integrity="" rel="stylesheet" href="{{rootURL}}assets/ghost.css" title="light">

    {{content-for "head-footer"}}
</head>
<body>

    <div class="ember-load-indicator">
        <div class="gh-loading-content">
            <video id="gh-loader-video" width="100" height="100" loop autoplay muted playsinline preload="metadata" style="width: 100px; height: 100px;">
                <source id="gh-loader-source" src="assets/videos/logo-loader.mp4" type="video/mp4" />
                <div class="gh-loading-spinner"></div>
            </video>
        </div>
    </div>

    <script>
        (function() {
            // Check for dark mode preference and set appropriate video
            function updateLoaderVideo() {
                const video = document.getElementById('gh-loader-video');
                const source = document.getElementById('gh-loader-source');

                if (!video || !source) return;

                let isDarkMode = false;

                // Priority 1: Check our own stored dark mode state
                const storedDarkMode = localStorage.getItem('ghost-admin-theme');
                if (storedDarkMode === 'dark') {
                    isDarkMode = true;
                }
                // Priority 2: Check system preference
                else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    isDarkMode = true;
                }

                const videoSrc = isDarkMode ? 'assets/videos/logo-loader-dark.mp4' : 'assets/videos/logo-loader.mp4';

                if (source.src !== videoSrc) {
                    source.src = videoSrc;
                    video.load(); // Reload video with new source
                }

                // Update background color to match theme
                const loadingContent = document.querySelector('.gh-loading-content');
                if (loadingContent) {
                    loadingContent.style.backgroundColor = isDarkMode ? '#15171A' : '#fff';
                }

                // Update document class and store state for next reload
                document.documentElement.classList.toggle('dark', isDarkMode);
                if (isDarkMode) {
                    localStorage.setItem('ghost-admin-theme', 'dark');
                } else {
                    localStorage.removeItem('ghost-admin-theme');
                }
            }

            // Listen for dark mode changes from Ghost admin and persist them
            function setupDarkModeSync() {
                // Watch for changes to the document's dark class
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const isDark = document.documentElement.classList.contains('dark');
                            
                            // Update stored preference
                            if (isDark) {
                                localStorage.setItem('ghost-admin-theme', 'dark');
                            } else {
                                localStorage.removeItem('ghost-admin-theme');
                            }
                            
                            // Update loader background if still visible
                            const loadingContent = document.querySelector('.gh-loading-content');
                            if (loadingContent) {
                                loadingContent.style.backgroundColor = isDark ? '#15171A' : '#fff';
                            }
                        }
                    });
                });

                observer.observe(document.documentElement, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }

            // Add artificial delay for testing loader (remove in production)
            function addTestingDelay() {
                const shouldDelay = localStorage.getItem('ghost-loader-test-delay') === 'true';
                if (shouldDelay) {
                    const loader = document.querySelector('.ember-load-indicator');
                    if (loader) {
                        // Keep loader visible for testing
                        setTimeout(() => {
                            loader.style.display = 'none';
                        }, 3000); // 3 second delay
                    }
                }
            }

            // Update video on load
            updateLoaderVideo();

            // Setup dark mode persistence
            setupDarkModeSync();

            // Add testing delay if enabled
            addTestingDelay();

            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateLoaderVideo);
        })();
    </script>

    {{content-for "body"}}

    {{content-for "body-footer"}}

    <script src="{{rootURL}}assets/vendor.js"></script>
    <script src="{{rootURL}}assets/ghost.js"></script>
</body>
</html>
