name: 'Load Docker Image'
description: 'Load Docker image from registry or artifact based on build source'
inputs:
  is-fork:
    description: 'Whether this is a fork PR build'
    required: true
  image-tags:
    description: 'Docker image tags (multi-line string)'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Download image artifact (fork PR)
      if: inputs.is-fork == 'true'
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load image from artifact (fork PR)
      if: inputs.is-fork == 'true'
      shell: bash
      run: |
        echo "Loading Docker image from artifact..."
        gunzip -c docker-image.tar.gz | docker load
        echo "Available images after load:"
        docker images

    - name: Log in to GitHub Container Registry
      if: inputs.is-fork == 'false'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Pull image from registry (main repo/branch)
      if: inputs.is-fork == 'false'
      shell: bash
      run: |
        # For main repo, extract first tag from multi-line registry tags
        IMAGE_TAG=$(echo "${{ inputs.image-tags }}" | head -n1)
        echo "Pulling image from registry: $IMAGE_TAG"
        docker pull "$IMAGE_TAG"

    - name: Verify image is available
      id: verify
      shell: bash
      run: |
        # Use the appropriate tag based on fork status
        if [ "${{ inputs.is-fork }}" = "true" ]; then
          IMAGE_TAG="${{ inputs.image-tags }}"
        else
          IMAGE_TAG=$(echo "${{ inputs.image-tags }}" | head -n1)
        fi
        echo "Checking for image: $IMAGE_TAG"
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

        if docker inspect "$IMAGE_TAG" > /dev/null 2>&1; then
          echo "✅ Image $IMAGE_TAG is available"
          echo "Image details:"
          docker inspect "$IMAGE_TAG" --format='{{.Id}} {{.Created}}'
        else
          echo "❌ Image $IMAGE_TAG is not available"
          echo "Available images:"
          docker images

          # For fork PRs, the image might have been loaded with a different tag
          if [ "${{ inputs.is-fork }}" = "true" ]; then
            echo ""
            echo "Searching for any loaded Ghost images..."
            docker images --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.CreatedAt}}" | grep -E "(ghost|Ghost)" || echo "No Ghost images found"
          fi
          exit 1
        fi

outputs:
  image-tag:
    description: 'The Docker image tag to use'
    value: ${{ steps.verify.outputs.image-tag }}