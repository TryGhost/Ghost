name: ghost-e2e
services:
  mysql:
    image: mysql:8.4.5
    command: --innodb-buffer-pool-size=1G --innodb-log-buffer-size=500M --innodb-change-buffer-max-size=50 --innodb-flush-log-at-trx_commit=0 --innodb-flush-method=O_DIRECT
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ghost_testing
      MYSQL_USER: ghost
      MYSQL_PASSWORD: ghost
    tmpfs:
      - /var/lib/mysql
    healthcheck:
      test: mysql -uroot -proot ghost_testing -e 'select 1'
      interval: 1s
      retries: 120

  ghost-migrations:
    image: ${GHOST_IMAGE_TAG:-ghost-monorepo:latest}
    pull_policy: never
    working_dir: /home/ghost
    command: ["yarn", "knex-migrator", "init"]
    environment:
      database__client: mysql2
      database__connection__host: mysql
      database__connection__user: root
      database__connection__password: root
      database__connection__database: ghost_testing
    depends_on:
      mysql:
        condition: service_healthy

  tinybird-local:
    image: tinybirdco/tinybird-local:latest
    platform: linux/amd64
    stop_grace_period: 2s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7181/v0/health" ]
      interval: 1s
      timeout: 5s
      retries: 120

  tb-cli:
    build:
      context: ../
      dockerfile: .docker/tb-cli/Dockerfile
    working_dir: /home/tinybird
    environment:
      - TB_HOST=http://tinybird-local:7181
      - TB_LOCAL_HOST=tinybird-local
    volumes:
      - ../ghost/core/core/server/data/tinybird:/home/tinybird
      - shared-config:/mnt/shared-config
    depends_on:
      tinybird-local:
        condition: service_healthy


volumes:
  shared-config:

networks:
  default:
    name: ghost_e2e
